ifdef::env-github[]
:tip-caption: :bulb:
:note-caption: :information_source:
:important-caption: :heavy_exclamation_mark:
:caution-caption: :fire:
:warning-caption: :warning:
endif::[]

= Lab 1-3: Prometheus JMX Exporterの展開

1-3 〜 1-5 のシナリオでは、アプリケーションのモニタリングデータを詳細に収集する一つの方法を体験します。OpenShift 以外のkuberntes デストロ環境でも度々採用されるPrometheusに、JavaアプリケーションのJMXからデータを取得し、可視化するまでのセットアップを行います。
通常、Prometheus のセットアップは、複雑な操作を伴いますが、OpenShift では、Operator を利用することで、省力的に専用の監視基盤を構築することができます。( 主に、Lab 1-4 、1-5 で扱います。)

== 1-3-1. Labで扱うアプリケーション構成

このLab 1-3では、監視対象となるJBoss EAPのJavaアプリケーションをデプロイした後、PrometheusのJMX(Java Management Extensions) Exporterを使ってこのアプリケーションのメトリクスデータを公開します。 +
後続するLab 1-4, 1-5で、Prometheus OperatorでPrometheusをデプロイし、JMXメトリクスデータを可視化します。 +

image::images/ocp4ws-ops/prometheus-arch-jmx-exporter.jpg[]

=== JMX Exporterは2つの動作を提供します。

- Java Agent +
Java Agent 用 JAR ファイルからメトリクスを収集 +
- HTTP server +
リモートの JMX ターゲットからメトリクスを取得しHTTPで公開

== 1-3-2. 監視対象となるJavaアプリケーションのデプロイ

=== OpenShiftコンソールへのログイン

ブラウザ(Chrome or Firefox)でOpenShift Webコンソールにログインします。

OpenShift WebコンソールのRULは、etherpad OpenShift WebコンソールのURLを参照ください。

////
`userX` としてログインしましょう。パスワードはetherpadの OpenShiftユーザのパスワードを参照ください。
(etherpadで予約したuser1,user2などのIDです)


Webコンソールの基本操作やクラスター内コンポーネントの基本的な動作の確認を行いたい場合は、前のハンズオンlink:ocp4ws-ops-1-1.adoc[OpenShiftクラスターへのログインと動作確認(Lab1-1)]を実施してください。
////

=== Javaアプリケーションのビルド

==== 1. Project作成

//// 
image::images/ocp4ws-ops/prometheus-arch-jmx-exporter.jpg[] 
////
監視アプリケーション用の"<LOGIN USER NAME>-jmx-monitor"という名前のProjectを作ります。 +

画面上部のプロジェクトドロップダウンリスとを展開し、プロジェクトの作成ボタンを押下します。

image::images/ocp4ws-ops/lab1-3-001.png[]

名前フィールドに、プロジェクト名（例："<LOGIN USER NAME>-jmx-monitor"）を入力し、作成ボタンを押下します。

image::images/ocp4ws-ops/lab1-3-002.png[]
image::images/ocp4ws-ops/lab1-3-003.png[]

NOTE: 以降の作業は全て"userX-jmx-monitor"Projectで行います。 +

image::images/ocp4ws-ops/lab1-3-004.png[]


=== Javaアプリケーションのデプロイ

==== 1. Javaアプリケーションのコンテナビルドと展開

"＋追加"メニューを選択し、追加の方法として、”Git リポジトリー" を選択します。

image::images/ocp4ws-ops/lab1-3-005.png[]

Git リポジトリーURLフィールドに、取得元となるURLとして``https://github.com/openlab-red/jboss-eap-prometheus``を入力します。

image::images/ocp4ws-ops/lab1-3-006.png[]

指定された取得されたデータにもとづき、画面の表示が変わるので、"作成"ボタンを押下します。

image::images/ocp4ws-ops/lab1-3-007.png[]

画面が、トポロジービューに切り替わります。各種リソースの作成、コンテナイメージのビルド、アプリケーションの実行が逐次実行されます。Deploymentを示すアイコンをクリックすると、画面右側に詳細情報を表示する画面が展開されます。ここから、タスクの状況や作成されたリソースを確認することができます。

image::images/ocp4ws-ops/lab1-3-008.png[]
image::images/ocp4ws-ops/lab1-3-009.png[]

Deploymentの処理が無事に完了すると、Pod がRunning ステータスとなります。

image::images/ocp4ws-ops/lab1-3-010.png[]

初期状態のアプリケーションのデプロイはここまでで完了です。

==== 2. Deploymentへ追加設定

Prometheus に対し、JMX のデータを提供できるように追加の設定を行います。

Runningステータスとなったことが確認できたら、右上”アクション”ドロップダウンリストより、Deploymentの編集を選びます。

image::images/ocp4ws-ops/lab1-3-011.png[]

Deployment のフォームビューにて画面をスクロールし、下方の”環境変数セクション”を表示します。

image::images/ocp4ws-ops/lab1-3-012.png[]

各フィールドにそれぞれ下記の様に入力します。

|===
|名前|値

|PREPEND_JAVA_OPTS
|"-javaagent:/opt/eap/prometheus/jmx-prometheus.jar=9404:/opt/eap/prometheus/config.yaml"
|===

NOTE: javaの起動パラメータとして、jarファイルと設定ファイルを指定しています。これらのファイルは、入手元のgitリポジトリに配置されていたもので、コンテナをビルドする際に、コンテナ内に配置されたものとなります。 +

image::images/ocp4ws-ops/lab1-3-013.png[]
image::images/ocp4ws-ops/lab1-3-014.png[]
image::images/ocp4ws-ops/lab1-3-015.png[]
image::images/ocp4ws-ops/lab1-3-016.png[]
image::images/ocp4ws-ops/lab1-3-017.png[]
image::images/ocp4ws-ops/lab1-3-018.png[]
image::images/ocp4ws-ops/lab1-3-019.png[]
image::images/ocp4ws-ops/lab1-3-020.png[]
image::images/ocp4ws-ops/lab1-3-021.png[]
image::images/ocp4ws-ops/lab1-3-022.png[]
image::images/ocp4ws-ops/lab1-3-023.png[]
image::images/ocp4ws-ops/lab1-3-024.png[]
image::images/ocp4ws-ops/lab1-3-025.png[]
image::images/ocp4ws-ops/lab1-3-026.png[]
image::images/ocp4ws-ops/lab1-3-027.png[]
image::images/ocp4ws-ops/lab1-3-028.png[]





ここでは、先程ビルドしたした「jboss-eap-prometheus」を利用して、アプリケーションを展開します。 +
デプロイでは、Java Agent用JARファイルやJMX Exporter設定ファイルのパスを環境変数(jmx-prometheus.jar=9404)で指定します。 +

[source,bash,role="execute"]
----
$ export JBOSS_HOME=/opt/eap

$ oc new-app -i jboss-eap-prometheus:latest \
  --name=jboss-eap-prometheus \
  -e PREPEND_JAVA_OPTS="-javaagent:${JBOSS_HOME}/prometheus/jmx-prometheus.jar=9404:${JBOSS_HOME}/prometheus/config.yaml"

--> Found image add9eb8 (14 minutes old) in image stream "jmx/jboss-eap-prometheus" under tag "latest" for "jboss-eap-prometheus:latest"

...(中略)

--> Success
    Application is not exposed. You can expose services to the outside world by executing one or more of the commands below:
     'oc expose svc/jboss-eap-prometheus'
    Run 'oc status' to view your app.
----

TIP: 必要に応じてJavaアプリケーションにAnnotationを付与することも可能です。 +

[source,bash,role="execute"]
----
$ oc annotate svc/jboss-eap-prometheus prometheus.io/scrape='true'

$ oc annotate svc/jboss-eap-prometheus prometheus.io/port='9404'

$ oc get svc jboss-eap-prometheus -o jsonpath='{.metadata.annotations}' |jq
{
  "openshift.io/generated-by": "OpenShiftNewApp",
  "prometheus.io/port": "9404",
  "prometheus.io/scrape": "true"
}
----

==== 2. 展開したJavaアプリケーションの確認 +

この時点で「jboss-eap-prometheus-1」がRunning状態になれば、デプロイ成功です。 +
JMX Exporter はデフォルトで9404ポートを公開しています。 +

[source,bash,role="execute"]
----
$ oc get svc jboss-eap-prometheus
NAME                   TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)                               AGE
jboss-eap-prometheus   ClusterIP   172.30.187.179   <none>        8080/TCP,8443/TCP,8778/TCP,9404/TCP   46s

$ oc get dc jboss-eap-prometheus
NAME                   READY   UP-TO-DATE   AVAILABLE   AGE
jboss-eap-prometheus   1/1     1            1           52s

$ oc get pod
NAME                                   READY   STATUS      RESTARTS   AGE
jboss-eap-prometheus-1-build           0/1     Completed   0          111s
jboss-eap-prometheus-b8fccc765-jplx2   1/1     Running     0          57s
----

「jboss-eap-prometheus-b8fccc765-jplx2」(b8fccc765-jplx2はランダムに生成)がRunning状態になるまで待ちましょう。 +


=== JavaアプリケーションのRoute設定

==== 1. JavaアプリケーションのRouter接続

次に「jboss-eap-prometheus」のアプリケーション(tcp-8080)ポートを、Routerに接続します。 +

[source,bash,role="execute"]
----
$ oc expose svc/jboss-eap-prometheus --name=tcp-8080 --port=8080
route.route.openshift.io/tcp-8080 exposed

$ oc get route tcp-8080
NAME       HOST/PORT                                                    PATH   SERVICES               PORT   TERMINATION   WILDCARD
tcp-8080   tcp-8080-user1-jmx-monitor.apps.cluster-3adc.3adc.sandbox691.opentlc.com          jboss-eap-prometheus   8080                 None
----

``oc get route``コマンドの出力の、``HOST/PORT``のカラムに表示されるURLにブラウザからアクセスすると、アプリケーションコンテンツが確認できます。 +
次のコマンドの出力で表示されるURLにブラウザでアクセスしてみましょう。JBoss EAPのインフォーメーション画面が表示されれば成功です。 +

[source,bash,role="execute"]
----
$ echo http://$(oc get route tcp-8080 -ojsonpath='{.spec.host}')
----

image::images/ocp4ws-ops/jboss-eap-prometheus-8080.jpg[Jboss Application]

==== 2. Prometheus ExporterのRouter接続

先程と同様に「jboss-eap-prometheus」のPromtheus Exporter(tcp-9404)ポートを、Routerに接続します。 +

----
$ oc expose svc/jboss-eap-prometheus --name=tcp-9404 --port=9404
route.route.openshift.io/tcp-9404 exposed

$ oc get route tcp-9404
NAME       HOST/PORT                                                    PATH   SERVICES               PORT   TERMINATION   WILDCARD
tcp-9404   tcp-9404-user3-jmx.apps.cluster-3adc.3adc.sandbox691.opentlc.com          jboss-eap-prometheus   9404                 None
----
再度``HOST/PORT``のカラムに表示されるURLにブラウザからアクセスしてみましょう。 +

[source,bash,role="execute"]
----
$ echo http://$(oc get route tcp-9404 -ojsonpath='{.spec.host}')
----

==== 3. JMX Exporterの確認を行います。 +

PromSQLのクエリが確認できれば成功です。

NOTE: ExporterがJVMから情報を集めるため少し時間がかかります。 +

image::images/ocp4ws-ops/jboss-eap-prometheus-9404.jpg[Jboss Application]

これで、JMX Exporterの設定は完了です。 +
次にlink:ocp4ws-ops-1-4.adoc[Prometheus Operator]の設定作業に進みます。 +
